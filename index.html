
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ (Phase 2.1)</title>
<style>
:root{--bg:#fff;--fg:#222;--accent:#0066cc;}
body.dark{--bg:#1e1e1e;--fg:#e0e0e0;--accent:#4ea1ff;}
body{margin:0;padding:20px;font-family:"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;
background:var(--bg);color:var(--fg);transition:.3s;}
.container{max-width:820px;margin:0 auto;padding:2rem;border-radius:8px;
background:var(--bg);box-shadow:0 2px 8px rgba(0,0,0,0.1);}
h1{text-align:center;margin-top:0;}
.controls{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;margin-bottom:1rem;}
select,button{font-size:1rem;padding:.5rem 1rem;border-radius:6px;
border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;}
button.secondary{background:transparent;color:var(--accent);}
#prompt{font-size:1.2em;line-height:1.6;margin-bottom:20px;min-height:5em;white-space:pre-wrap;}
textarea{width:100%;height:160px;font-size:1.1em;padding:1rem;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
.countdown{font-size:2em;text-align:center;margin:20px;}
#stats p{margin:.3rem 0;text-align:center;}
#history{margin-top:2rem;}
#history h2{margin-bottom:.5rem;text-align:center;}
#history ul{list-style:none;padding:0;text-align:center;}
#history li{margin:.3rem 0;}
</style>
</head>
<body>
<div class="container">
  <h1>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ (Phase 2.1)</h1>
  <div class="controls">
    <label>æ™‚é–“:
      <select id="timeSelect">
        <option value="30">30ç§’</option>
        <option value="60" selected>60ç§’</option>
        <option value="90">90ç§’</option>
      </select>
    </label>
    <button id="themeToggle" class="secondary">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
    <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>
  <div id="prompt"></div>
  <textarea id="inputArea" disabled></textarea>
  <div class="countdown" id="countdown"></div>
  <div id="stats"></div>
  <div id="history">
    <h2>ç›´è¿‘10ä»¶ã®çµæœ</h2>
    <ul id="historyList"><li>èª­ã¿è¾¼ã¿ä¸­...</li></ul>
  </div>
</div>

<script type="module">
// Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3DHKWFO2VPp9_qBVpTb1UxYMcJ3JVRwI",
  authDomain: "japantyping-91298.firebaseapp.com",
  projectId: "japantyping-91298",
  storageBucket: "japantyping-91298.firebasestorage.app",
  messagingSenderId: "995539299826",
  appId: "1:995539299826:web:3a8dfbe7c30acd82c50f6b",
  measurementId: "G-2Q2V33DY7F"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
signInAnonymously(auth).catch(console.error);

// DOM refs
const promptDiv  = document.getElementById('prompt');
const inputArea  = document.getElementById('inputArea');
const startBtn   = document.getElementById('startBtn');
const countdownDiv = document.getElementById('countdown');
const statsDiv   = document.getElementById('stats');
const timeSelect = document.getElementById('timeSelect');
const themeToggle= document.getElementById('themeToggle');
const historyList= document.getElementById('historyList');

// sentences & prompt generator
const sentences = [
  "ãƒ‘ã‚½ã‚³ãƒ³ã‚’ä½¿ã„ã“ãªã™ã“ã¨ã§ç”Ÿæ´»ã¯ã‚ˆã‚Šä¾¿åˆ©ã§è±Šã‹ã«ãªã‚Šã¾ã™ã€‚",
  "ãƒ¡ãƒ¼ãƒ«ã‚’æ›¸ã„ãŸã‚Šå†™çœŸã‚’æ•´ç†ã—ãŸã‚Šä¸–ç•Œä¸­ã®æƒ…å ±ã‚’æ¤œç´¢ã—ãŸã‚Šã¨å¯èƒ½æ€§ã¯ç„¡é™ã§ã™ã€‚",
  "ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ã‚¹ã‚­ãƒ«ã‚’èº«ã«ã¤ã‘ã‚Œã°æ–‡ç« ä½œæˆã‚„ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã®é€Ÿåº¦ãŒé£›èºçš„ã«å‘ä¸Šã—ã¾ã™ã€‚",
  "è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§ç·´ç¿’ã‚’ç¶šã‘ã‚‹ã“ã¨ãŒä¸Šé”ã¸ã®è¿‘é“ã§ã™ã€‚",
  "æ­£ã—ã„ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ä¿ã¡ç”»é¢ã‚’è¦‹ãªãŒã‚‰æŒ‡å…ˆã®æ„Ÿè¦šã§å…¥åŠ›ã™ã‚‹ã“ã¨ã§è‡ªç„¶ã¨ã‚¿ãƒƒãƒã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãŒèº«ã«ã¤ãã¾ã™ã€‚",
  "çŸ­æ™‚é–“ã§ã‚‚é›†ä¸­ã—ã¦ç·´ç¿’ã‚’è¡Œã†ã“ã¨ã§ç¶™ç¶šã—ã‚„ã™ããƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ç¶­æŒã§ãã¾ã™ã€‚",
  "æ¯æ—¥ã®å°ã•ãªç©ã¿é‡ã­ãŒå¤§ããªæˆæœã«ã¤ãªãŒã‚Šã¾ã™ã€‚"
];
const targetLength = sec => sec * 3;
const buildPrompt = len => {
  let p=""; while(p.length < len){ p += (p?" ":"") + sentences[Math.floor(Math.random()*sentences.length)]; }
  return p;
};

// Theme toggle
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  themeToggle.textContent = document.body.classList.contains('dark') ? "â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰" : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰";
});

// Typing logic
let promptText="", timeLimit=60, timeLeft=60, timerInterval;
inputArea.addEventListener('input', ()=> {
  if(!inputArea.disabled && inputArea.value.length >= promptText.length) finishTest();
});
startBtn.addEventListener('click', startTest);

function startTest(){
  reset();
  timeLimit = parseInt(timeSelect.value,10);
  timeLeft  = timeLimit;
  promptText= buildPrompt(targetLength(timeLimit));
  promptDiv.textContent = promptText;

  let count=3; countdownDiv.textContent = count;
  const pre=setInterval(()=>{count--;
    if(count>0) countdownDiv.textContent=count;
    else{
      clearInterval(pre);
      countdownDiv.textContent="ã‚¹ã‚¿ãƒ¼ãƒˆï¼";
      inputArea.disabled=false; inputArea.focus();
      timerInterval=setInterval(()=>{
        timeLeft--; countdownDiv.textContent=`æ®‹ã‚Š ${timeLeft} ç§’`;
        if(timeLeft<=0) finishTest();
      },1000);
    }
  },1000);
}

async function finishTest(){
  clearInterval(timerInterval); inputArea.disabled=true; countdownDiv.textContent="çµ‚äº†";
  const typed=inputArea.value;
  let correct=0; for(let i=0;i<typed.length;i++){ if(typed[i]===promptText[i]) correct++; }
  const accuracy=typed.length?Math.round(correct/typed.length*100):0;
  const wpm=Math.round((typed.length/2)/((timeLimit-(timeLeft||0))/60));
  statsDiv.innerHTML=`<p>å…¥åŠ›æ–‡å­—æ•°: ${typed.length} æ–‡å­—</p><p>æ­£ç¢ºç‡: ${accuracy}%</p><p>WPM: ${wpm}</p>`;
  try{
    const uid=auth.currentUser.uid;
    await addDoc(collection(db,"users",uid,"results"),{
      wpm,accuracy,chars:typed.length,level:timeLimit+"s",ts:Date.now()
    });
    await loadHistory();
  }catch(e){
    console.error("ä¿å­˜å¤±æ•—",e);
    alert("æˆç¸¾ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

async function loadHistory(){
  historyList.innerHTML="<li>èª­ã¿è¾¼ã¿ä¸­...</li>";
  const uid=auth.currentUser?.uid;
  if(!uid){ historyList.innerHTML="<li>æœªãƒ­ã‚°ã‚¤ãƒ³</li>"; return; }
  try{
    const q=query(collection(db,"users",uid,"results"),orderBy("ts","desc"),limit(10));
    const snaps=await getDocs(q);
    historyList.innerHTML="";
    snaps.forEach(doc=>{
      const d=doc.data();
      const li=document.createElement('li');
      li.textContent=`${new Date(d.ts).toLocaleString()} - WPM:${d.wpm} / æ­£ç¢ºç‡:${d.accuracy}% / ${d.level}`;
      historyList.appendChild(li);
    });
    if(historyList.childElementCount===0){
      historyList.innerHTML="<li>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</li>";
    }
  }catch(e){
    console.error("å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼",e);
    historyList.innerHTML="<li style='color:red'>å±¥æ­´ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</li>";
  }
}

onAuthStateChanged(auth, user=>{
  if(user) loadHistory();
});

// helpers
function reset(){
  inputArea.value=""; inputArea.disabled=true;
  statsDiv.textContent=""; countdownDiv.textContent="";
}
</script>
</body>
</html>
