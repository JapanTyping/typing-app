
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>タイピング練習 (Phase 2.1)</title>
<style>
:root{--bg:#fff;--fg:#222;--accent:#0066cc;}
body.dark{--bg:#1e1e1e;--fg:#e0e0e0;--accent:#4ea1ff;}
body{margin:0;padding:20px;font-family:"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;
background:var(--bg);color:var(--fg);transition:.3s;}
.container{max-width:820px;margin:0 auto;padding:2rem;border-radius:8px;
background:var(--bg);box-shadow:0 2px 8px rgba(0,0,0,0.1);}
h1{text-align:center;margin-top:0;}
.controls{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;margin-bottom:1rem;}
select,button{font-size:1rem;padding:.5rem 1rem;border-radius:6px;
border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;}
button.secondary{background:transparent;color:var(--accent);}
#prompt{font-size:1.2em;line-height:1.6;margin-bottom:20px;min-height:5em;white-space:pre-wrap;}
textarea{width:100%;height:160px;font-size:1.1em;padding:1rem;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
.countdown{font-size:2em;text-align:center;margin:20px;}
#stats p{margin:.3rem 0;text-align:center;}
#history{margin-top:2rem;}
#history h2{margin-bottom:.5rem;text-align:center;}
#history ul{list-style:none;padding:0;text-align:center;}
#history li{margin:.3rem 0;}
</style>
</head>
<body>
<div class="container">
  <h1>タイピング練習 (Phase 2.1)</h1>
  <div class="controls">
    <label>時間:
      <select id="timeSelect">
        <option value="30">30秒</option>
        <option value="60" selected>60秒</option>
        <option value="90">90秒</option>
      </select>
    </label>
    <button id="themeToggle" class="secondary">🌙 ダークモード</button>
    <button id="startBtn">スタート</button>
  </div>
  <div id="prompt"></div>
  <textarea id="inputArea" disabled></textarea>
  <div class="countdown" id="countdown"></div>
  <div id="stats"></div>
  <div id="history">
    <h2>直近10件の結果</h2>
    <ul id="historyList"><li>読み込み中...</li></ul>
  </div>
</div>

<script type="module">
// Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3DHKWFO2VPp9_qBVpTb1UxYMcJ3JVRwI",
  authDomain: "japantyping-91298.firebaseapp.com",
  projectId: "japantyping-91298",
  storageBucket: "japantyping-91298.firebasestorage.app",
  messagingSenderId: "995539299826",
  appId: "1:995539299826:web:3a8dfbe7c30acd82c50f6b",
  measurementId: "G-2Q2V33DY7F"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
signInAnonymously(auth).catch(console.error);

// DOM refs
const promptDiv  = document.getElementById('prompt');
const inputArea  = document.getElementById('inputArea');
const startBtn   = document.getElementById('startBtn');
const countdownDiv = document.getElementById('countdown');
const statsDiv   = document.getElementById('stats');
const timeSelect = document.getElementById('timeSelect');
const themeToggle= document.getElementById('themeToggle');
const historyList= document.getElementById('historyList');

// sentences & prompt generator
const sentences = [
  "パソコンを使いこなすことで生活はより便利で豊かになります。",
  "メールを書いたり写真を整理したり世界中の情報を検索したりと可能性は無限です。",
  "タイピングのスキルを身につければ文章作成やデータ入力の速度が飛躍的に向上します。",
  "自分のペースで練習を続けることが上達への近道です。",
  "正しいホームポジションを保ち画面を見ながら指先の感覚で入力することで自然とタッチタイピングが身につきます。",
  "短時間でも集中して練習を行うことで継続しやすくモチベーションも維持できます。",
  "毎日の小さな積み重ねが大きな成果につながります。"
];
const targetLength = sec => sec * 3;
const buildPrompt = len => {
  let p=""; while(p.length < len){ p += (p?" ":"") + sentences[Math.floor(Math.random()*sentences.length)]; }
  return p;
};

// Theme toggle
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  themeToggle.textContent = document.body.classList.contains('dark') ? "☀️ ライトモード" : "🌙 ダークモード";
});

// Typing logic
let promptText="", timeLimit=60, timeLeft=60, timerInterval;
inputArea.addEventListener('input', ()=> {
  if(!inputArea.disabled && inputArea.value.length >= promptText.length) finishTest();
});
startBtn.addEventListener('click', startTest);

function startTest(){
  reset();
  timeLimit = parseInt(timeSelect.value,10);
  timeLeft  = timeLimit;
  promptText= buildPrompt(targetLength(timeLimit));
  promptDiv.textContent = promptText;

  let count=3; countdownDiv.textContent = count;
  const pre=setInterval(()=>{count--;
    if(count>0) countdownDiv.textContent=count;
    else{
      clearInterval(pre);
      countdownDiv.textContent="スタート！";
      inputArea.disabled=false; inputArea.focus();
      timerInterval=setInterval(()=>{
        timeLeft--; countdownDiv.textContent=`残り ${timeLeft} 秒`;
        if(timeLeft<=0) finishTest();
      },1000);
    }
  },1000);
}

async function finishTest(){
  clearInterval(timerInterval); inputArea.disabled=true; countdownDiv.textContent="終了";
  const typed=inputArea.value;
  let correct=0; for(let i=0;i<typed.length;i++){ if(typed[i]===promptText[i]) correct++; }
  const accuracy=typed.length?Math.round(correct/typed.length*100):0;
  const wpm=Math.round((typed.length/2)/((timeLimit-(timeLeft||0))/60));
  statsDiv.innerHTML=`<p>入力文字数: ${typed.length} 文字</p><p>正確率: ${accuracy}%</p><p>WPM: ${wpm}</p>`;
  try{
    const uid=auth.currentUser.uid;
    await addDoc(collection(db,"users",uid,"results"),{
      wpm,accuracy,chars:typed.length,level:timeLimit+"s",ts:Date.now()
    });
    await loadHistory();
  }catch(e){
    console.error("保存失敗",e);
    alert("成績の保存に失敗しました。ブラウザのコンソールを確認してください。");
  }
}

async function loadHistory(){
  historyList.innerHTML="<li>読み込み中...</li>";
  const uid=auth.currentUser?.uid;
  if(!uid){ historyList.innerHTML="<li>未ログイン</li>"; return; }
  try{
    const q=query(collection(db,"users",uid,"results"),orderBy("ts","desc"),limit(10));
    const snaps=await getDocs(q);
    historyList.innerHTML="";
    snaps.forEach(doc=>{
      const d=doc.data();
      const li=document.createElement('li');
      li.textContent=`${new Date(d.ts).toLocaleString()} - WPM:${d.wpm} / 正確率:${d.accuracy}% / ${d.level}`;
      historyList.appendChild(li);
    });
    if(historyList.childElementCount===0){
      historyList.innerHTML="<li>まだ記録がありません</li>";
    }
  }catch(e){
    console.error("履歴取得エラー",e);
    historyList.innerHTML="<li style='color:red'>履歴を取得できませんでした</li>";
  }
}

onAuthStateChanged(auth, user=>{
  if(user) loadHistory();
});

// helpers
function reset(){
  inputArea.value=""; inputArea.disabled=true;
  statsDiv.textContent=""; countdownDiv.textContent="";
}
</script>
</body>
</html>
